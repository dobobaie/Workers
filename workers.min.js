var Workers=function(){var t={NONE:null,TYPE:{ROOT:"root",PARENT:"parent",NODE:"node"},STATUS:{WAITING:"waiting",RUNNING:"running",FINISH:"finish"}};Object.values="function"!=typeof Object.values?function(t){return Object.keys(t).map(function(e){return t[e]})}:Object.values;var e=function(r){this.create=function(r,n,i){return void 0!==c.children[r]||void 0!==c.this[r]?null:(c.children[r]=new e(r),c.children[r].init(c.this,t.TYPE.PARENT),c.children[r].set(n,i),c.this[r]=c.children[r],c.this[r])},this.init=function(e,r,n){switch(c.parent=e,c.type=r,c.id=n,r){case t.TYPE.ROOT:delete c.this.cancel,delete c.this.getId,delete c.this.timeout,delete c.this.interval,delete c.this.run,delete c.this.stack,delete c.this.pop,delete c.this.set,delete c.this.parent,delete c.this.root,delete c.this.node;break;case t.TYPE.PARENT:delete c.this.getId,delete c.this.pop,delete c.this.root;break;case t.TYPE.NODE:delete c.this.cancel,delete c.this.timeout,delete c.this.interval,delete c.this.run,delete c.this.stack,delete c.this.node}return delete c.this.init,c.this},this.set=function(r,n){n=null==n||0==Array.isArray(n)||void 0==n[0]?[n]:Object.values(n);for(var i in n){var a=new e(c.name);a.init(c.this,t.TYPE.NODE,i),u.nodes.push(a),u.workers+=1}return u.data=n,u.callback=r,c.status=t.STATUS.WAITING,c.this.addWorker(),delete c.this.set,c.this},this.stack=function(){return u.stack.status=!0,c.this.run(),delete c.this.stack,delete c.this.timeout,delete c.this.interval,c.this},this.timeout=function(t){return t=null==t||"number"!=typeof t?1:t,setTimeout(c.this.run,t),delete c.this.stack,delete c.this.timeout,delete c.this.interval,c.this},this.interval=function(t){return t=null==t||"number"!=typeof t?1e3:t,u.haveInterval=setInterval(c.this.run,t),c.this.stop=function(){c.this.removeWorker(!1),clearInterval(u.haveInterval)},delete c.this.stack,delete c.this.timeout,delete c.this.interval,c.this},this.run=function(){c.status=t.STATUS.RUNNING;for(var e in u.data)n(e);return null==u.haveInterval&&c.this.removeWorker(!1),delete c.this.stack,delete c.this.timeout,delete c.this.interval,c.this};var n=function(e){if(!0!==u.stack.status||u.stack.currentNode!==parseInt(e)||u.stack.isRunning!==t.STATUS.WAITING)if(!0!==u.stack.status)if(u.stack.currentNode>parseInt(e))c.this.waiting(a(e),!0,!0);else if(u.maxWorkers>0&&u.maxWorkers<=u.runningWorkers)c.this.waiting(a(e),!0,!0);else{var r=i();0===u.maxWorkers&&null!=r&&r.getLimit()<=r.getTotalRunningWorkers()+c.this.getRunningWorkers()?r.waiting(a(e),!0,!0):o(e)}else c.this.waiting(a(e),!0,!0);else o(e,!0)},i=function(t){return void 0===t&&null!=c.parent?i(c.parent):void 0!==t&&0===t.getLimit()&&"function"==typeof t.root?i(t.root()):t},a=function(t){return function(e){n(t),e()}},o=function(e,r){!1===r&&(u.stack.currentNode+=1),u.runningWorkers+=1,u.nodes[e].addWorker(!0),u.stack.isRunning=t.STATUS.RUNNING,u.callback(u.nodes[e],u.data[e])};this.cancel=function(){return c.this.removeWorker(!0,!0),c.this},this.pop=function(){return c.totalWorkers-=1,0===c.totalWorkers&&0===c.totalWaitingWorkers&&l(),c.parent.removeWorker(!0,!0),c.this},this.getName=function(){return c.name},this.getType=function(){return c.type},this.getId=function(){return c.id},this.getStatus=function(){return c.status},this.getLimit=function(){return u.maxWorkers},this.getWorkers=function(){return u.workers},this.getWaitingWorkers=function(){return u.waitingWorkers},this.getRunningWorkers=function(){return u.runningWorkers},this.getTotalWorkers=function(){return c.totalWorkers},this.getTotalWaitingWorkers=function(){return c.totalWaitingWorkers},this.getTotalRunningWorkers=function(){return c.totalRunningWorkers},this.limit=function(t){return u.maxWorkers=t,c.this},this.waiting=function(t,e,r){return c.totalWaitingWorkers+=1,"boolean"==typeof r&&!0===r&&(u.waitingWorkers+=1,c.waitingCallback.push({callback:function(e){u.waitingWorkers-=1,t(e)},removeAfterCall:e})),null!=c.parent?(c.parent.waiting(t,e,!1),c.this):c.this},this.complete=function(t,e){return 0===c.totalWorkers&&(t(c.error,c.fatalError),"boolean"!=typeof e||1==e)?c.this:(c.completeCallback.push({callback:t,removeAfterCall:e}),c.this)},this.addWorker=function(t){return"boolean"==typeof t&&!0===t&&(c.totalRunningWorkers+=1),c.totalWorkers+=1,null!==c.parent&&c.parent.addWorker(t),c.this},this.removeWorker=function(e,r){return"boolean"==typeof e&&!0===e&&(u.workers-=1,u.runningWorkers-=1,c.status=t.STATUS.FINISH,!0===u.stack.status&&(u.stack.currentNode+=1,u.stack.isRunning=t.STATUS.WAITING)),"boolean"==typeof r&&!0===r&&(c.totalRunningWorkers-=1),c.totalWorkers-=1,0!==u.waitingWorkers&&s(),0===c.totalWorkers&&0===c.totalWaitingWorkers&&l(),null!==c.parent&&c.parent.removeWorker(!1,r),c.this},this.error=function(t,e){return c.error=null===c.error?t:c.error,c.fatalError=null===c.fatalError?e:c.fatalError,null!==c.parent&&c.parent.error(t,e),c.this},this.save=function(t){return c.save=t,c.this},this._save=function(t){var e=c.parent;return null==e?e:e.save(t)},this.get=function(){return c.save},this._get=function(){var t=c.parent;return null==t?t:t.get()},this.root=function(){return c.parent},this.parent=function(e,r){return null==c.parent?null:(r=void 0==r?t.TYPE.PARENT:r,c.parent.getName()!==e||r!==t.NONE&&c.parent.getType()!==r?void 0===c.parent.parent?null:c.parent.parent(e,r):c.parent)},this.parentNode=function(e){return c.this.parent(e,t.TYPE.NODE)},this.node=function(t){return void 0==c.nodes[t]?null:c.nodes[t]};var s=function(){var t=c.waitingCallback;c.waitingCallback=[];for(var e in t)"boolean"==typeof t[e].removeAfterCall&&0==t[e].removeAfterCall&&c.waitingCallback.push(t[e]),t[e].callback(function(){return c.totalWaitingWorkers-=1,0===c.totalWorkers&&0===c.totalWaitingWorkers&&l(),c.this})},l=function(){var t=c.completeCallback;c.completeCallback=[];for(var e in t)"boolean"==typeof t[e].removeAfterCall&&0==t[e].removeAfterCall&&c.completeCallback.push(t[e]),t[e].callback(c.error,c.fatalError)},u={maxWorkers:0,wasRejected:!1,haveInterval:null,nodes:[],workers:0,runningWorkers:0,waitingWorkers:0,data:[],callback:null,stack:{status:!1,currentNode:0,isRunning:t.STATUS.WAITING}},c={this:this,id:null,name:r,parent:null,status:t.NONE,type:t.NONE,save:null,error:null,fatalError:null,children:{},completeCallback:[],waitingCallback:[],totalWorkers:0,totalRunningWorkers:0,totalWaitingWorkers:0}};return new e("root").init(null,t.TYPE.ROOT)};module.exports=Workers;