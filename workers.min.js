var Workers=function(){var t={NONE:null,TYPE:{ROOT:"root",PARENT:"parent",NODE:"node"},STATUS:{WAITING:"waiting",RUNNING:"running",FINISH:"finish"}};Object.values="function"!=typeof Object.values?function(t){return Object.keys(t).map(function(e){return t[e]})}:Object.values;var e=function(r){this.create=function(r,n,i){return i="function"==typeof r?n:i,n="function"==typeof r?r:n,null===(r="function"==typeof r?null:r)||void 0===c.children[r]&&void 0===c.this[r]?(c.children[r]=new e(r),c.children[r].init(c.this,t.TYPE.PARENT),c.children[r].set(n,i),null!==r&&(c.this[r]=c.children[r]),c.children[r]):null},this.init=function(e,r,n){switch(c.parent=e,c.type=r,c.id=n,r){case t.TYPE.ROOT:delete c.this.push,delete c.this.cancel,delete c.this.getId,delete c.this.timeout,delete c.this.interval,delete c.this.run,delete c.this.stack,delete c.this.pop,delete c.this.set,delete c.this.parent,delete c.this.root,delete c.this.node,delete c.this.getNodeStatus;break;case t.TYPE.PARENT:delete c.this.getId,delete c.this.pop,delete c.this.root,delete c.this.getNodeStatus;break;case t.TYPE.NODE:delete c.this.push,delete c.this.cancel,delete c.this.timeout,delete c.this.interval,delete c.this.run,delete c.this.stack,delete c.this.node}return delete c.this.init,c.this},this.set=function(r,n){n=null===n&&void 0!==n?[]:0==Array.isArray(n)||void 0==n[0]?[n]:Object.values(n);for(var i in n){var o=new e(c.name);o.init(c.this,t.TYPE.NODE,i),l.nodes.push(o),l.workers+=1}return l.data=n,l.callback=r,c.status=t.STATUS.WAITING,c.this.addWorker(),delete c.this.set,c.this},this.stack=function(){return l.stack.status=!0,c.this.run(),new Promise(function(t,e){c.this.then(t).catch(e)})},this.timeout=function(t){return t=null==t||"number"!=typeof t?1:t,setTimeout(c.this.run,t),new Promise(function(t,e){c.this.then(t).catch(e)})},this.interval=function(t){return t=null==t||"number"!=typeof t?1e3:t,l.haveInterval=setInterval(c.this.run,t),c.this.stop=function(){c.this.removeWorker(!1),clearInterval(l.haveInterval)},new Promise(function(t,e){c.this.then(t).catch(e)})},this.run=function(){c.status=t.STATUS.RUNNING;for(var e in l.data)n(e);return null==l.haveInterval&&c.this.removeWorker(!1),0===l.runningWorkers&&0===l.waitingWorkers&&c.status===t.STATUS.RUNNING&&(c.status=t.STATUS.FINISH),new Promise(function(t,e){c.this.then(t).catch(e)})};var n=function(e){if(!0!==l.stack.status||l.stack.currentNode!==parseInt(e)||l.stack.isRunning!==t.STATUS.WAITING)if(!0!==l.stack.status)if(l.stack.currentNode>parseInt(e))c.this.waiting(o(e),!0,!0);else if(l.limitWorkers>0&&l.limitWorkers<=l.runningWorkers&&!1===l.limitExtra)c.this.waiting(o(e),!0,!0);else{var r=i();(0===l.limitWorkers||!0===l.limitExtra)&&null!=r&&r.getLimit()>0&&r.getLimit()<=r.getTotalRunningWorkers()+c.this.getRunningWorkers()&&r.getLimit()+(1==l.limitExtra?l.limitWorkers:0)<=r.getTotalRunningWorkers()+c.this.getRunningWorkers()?r.waiting(o(e),!0,!0):s(e)}else c.this.waiting(o(e),!0,!0);else s(e,!0)},i=function(t){return void 0===t&&null!=c.parent?i(c.parent):void 0!==t&&0===t.getLimit()&&"function"==typeof t.root?i(t.root()):t},o=function(t){return function(e){n(t),e()}},s=function(e,r){!1===r&&(l.stack.currentNode+=1),l.runningWorkers+=1,l.nodes[e].addWorker(!0,!0),l.stack.isRunning=t.STATUS.RUNNING;try{l.callback(l.nodes[e],l.data[e])}catch(t){l.nodes[e].error(t),l.nodes[e].pop()}};this.push=function(r){if(null==r)return c.this;var i=l.data.push(r)-1,o=new e(c.name);return o.init(c.this,t.TYPE.NODE,i),l.nodes.push(o),l.workers+=1,c.status=t.STATUS.RUNNING,n(i),c.this},this.cancel=function(){return c.this.removeWorker(!0,!0),c.this},this.pop=function(){if(c.nodeStatus!=t.STATUS.FINISH)return c.totalWorkers-=1,0===c.totalWorkers&&0===c.totalWaitingWorkers&&(u(null!==c.error?"catch":"then"),u("complete")),c.parent.removeWorker(!0,!0),c.this},this.limit=function(t,e){return l.limitExtra="boolean"==typeof e&&!1!==e,l.limitWorkers=t<-1?-1:t,l.limitWorkers=!0===l.limitExtra&&-1===l.limitWorkers?0:l.limitWorkers,c.this},this.addWorker=function(e,r){return"boolean"==typeof e&&!0===e&&(c.nodeStatus=t.STATUS.RUNNING),"boolean"==typeof r&&!0===r&&(c.totalRunningWorkers+=1),c.totalWorkers+=1,null!==c.parent&&c.parent.addWorker(!1,r),c.this},this.removeWorker=function(e,r){return"boolean"==typeof e&&!0===e&&(l.workers-=1,l.runningWorkers-=1,c.status=t.STATUS.FINISH,c.nodeStatus=t.STATUS.FINISH,!0===l.stack.status&&(l.stack.currentNode+=1,l.stack.isRunning=t.STATUS.WAITING)),"boolean"==typeof r&&!0===r&&(c.totalRunningWorkers-=1),c.totalWorkers-=1,0!==l.waitingWorkers&&u("waiting"),0===c.totalWorkers&&0===c.totalWaitingWorkers&&(u(null!==c.error?"catch":"then"),u("complete")),null!==c.parent&&c.parent.removeWorker(!1,r),c.this},this.removeWaitingWorker=function(){return c.totalWaitingWorkers-=1,0===c.totalWorkers&&0===c.totalWaitingWorkers&&(u(null!==c.error?"catch":"then"),u("complete")),null!=c.parent?(c.parent.removeWaitingWorker(),c.this):c.this},this.error=function(t){return c.error=null===c.error?t:c.error,null!==c.parent&&c.parent.error(t),c.this},this.save=function(t){return c.save=t,c.this},this._save=function(t){var e=c.parent;return null!==e&&e.save(t),c.this},this.get=function(){return c.save},this._get=function(){var t=c.parent;return null==t?t:t.get()},this.root=function(){return c.parent},this.parent=function(e,r){return null==c.parent?null:(r=void 0==r?t.TYPE.PARENT:r,c.parent.getName()!==e||r!==t.NONE&&c.parent.getType()!==r?void 0===c.parent.parent?null:c.parent.parent(e,r):c.parent)},this.parentNode=function(e){return c.this.parent(e,t.TYPE.NODE)},this.node=function(t){return void 0==l.nodes[t]?null:l.nodes[t]},this.waiting=function(t,e,r){return c.totalWaitingWorkers+=1,"boolean"==typeof r&&!0===r&&(l.waitingWorkers+=1,a("waiting",function(e){l.waitingWorkers-=1,t(e)},e,function(){return c.this.removeWaitingWorker})),null!=c.parent?(c.parent.waiting(t,e,!1),c.this):c.this},this.complete=function(t,e){return 0===c.totalWorkers&&(t(c.error),"boolean"!=typeof e||1==e)?c.this:(a("complete",t,e,function(){return c.error}),c.this)},this.then=function(t,e){return 0===c.totalWorkers&&null===c.error&&(t(c.save),"boolean"!=typeof e||1==e)?c.this:(a("then",t,e,function(){return c.save}),c.this)},this.catch=function(t,e){return 0===c.totalWorkers&&null!==c.error&&(t(c.error),"boolean"!=typeof e||1==e)?c.this:(a("catch",t,e,function(){return c.error}),c.this)};var a=function(t,e,r,n){return c.callback.push({type:t,callback:e,removeAfterCall:r,params:n}),c.this},u=function(t){var e=c.callback;c.callback=[];for(var r in e)e[r].type===t?("boolean"==typeof e[r].removeAfterCall&&0==e[r].removeAfterCall&&c.callback.push(e[r]),e[r].callback(e[r].params())):c.callback.push(e[r])};this.getName=function(){return c.name},this.getType=function(){return c.type},this.getId=function(){return c.id},this.getStatus=function(){return c.status},this.getNodeStatus=function(){return c.nodeStatus},this.getLimit=function(){return l.limitWorkers},this.getWorkers=function(){return l.workers},this.getWaitingWorkers=function(){return l.waitingWorkers},this.getRunningWorkers=function(){return l.runningWorkers},this.getTotalWorkers=function(){return c.totalWorkers},this.getTotalWaitingWorkers=function(){return c.totalWaitingWorkers},this.getTotalRunningWorkers=function(){return c.totalRunningWorkers},this.getNodes=function(){return l.nodes};var l={limitWorkers:0,limitExtra:!1,wasRejected:!1,haveInterval:null,nodes:[],workers:0,runningWorkers:0,waitingWorkers:0,data:[],callback:null,stack:{status:!1,currentNode:0,isRunning:t.STATUS.WAITING}},c={this:this,id:null,name:r,parent:null,status:t.NONE,nodeStatus:t.NONE,type:t.NONE,save:null,error:null,children:{},callback:[],totalWorkers:0,totalRunningWorkers:0,totalWaitingWorkers:0}};return new e("root").init(null,t.TYPE.ROOT)};try{module.exports=Workers}catch(t){}